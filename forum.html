<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ფორუმის სექცია • Zaratic Role Play</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/OGSunny/Testerweb/main/lv_0_20251120194047.jpg" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;500;700;900&family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #e74c3c;
            --primary-light: #ff6b57;
            --primary-dark: #c0392b;
            --secondary: #2c3e50;
            --accent: #3498db;
            --dark: #0a0d1b;
            --darker: #050609;
            --glass: rgba(15, 20, 40, 0.85);
            --glass-light: rgba(20, 28, 50, 0.6);
            --border: rgba(231, 76, 60, 0.3);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --neon-glow: 0 0 5px #e74c3c;
            --shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Noto Sans Georgian', 'Montserrat', sans-serif;
            background: #000000;
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }

        #particles-js { 
            position: fixed; 
            width: 100%; 
            height: 100%; 
            top: 0; 
            left: 0; 
            z-index: -2; 
            background: radial-gradient(ellipse at top, #1a1f3a 0%, #000000 50%); 
            pointer-events: none;
        }

        .glow-orbs { 
            position: fixed; 
            width: 100%; 
            height: 100%; 
            top: 0; 
            left: 0; 
            z-index: -1; 
            overflow: hidden; 
            pointer-events: none; 
        }
        .orb { 
            position: absolute; 
            border-radius: 50%; 
            filter: blur(100px); 
            opacity: 0.2; 
            animation: float 20s ease-in-out infinite; 
        }
        .orb-1 { width: 500px; height: 500px; background: var(--primary); top: -15%; left: 15%; }
        .orb-2 { width: 450px; height: 450px; background: var(--accent); top: 60%; right: 10%; animation-direction: reverse; animation-duration: 25s; }
        .orb-3 { width: 300px; height: 300px; background: var(--primary-light); bottom: -10%; left: 50%; animation-duration: 28s; }

        @keyframes float { 
            0%,100% { transform: translate(0,0) scale(1); } 
            33% { transform: translate(50px,-50px) scale(1.05); } 
            66% { transform: translate(-30px,30px) scale(0.95); } 
        }

        header { 
            position: fixed; top: 0; left: 0; width: 100%; padding: 15px 5%; 
            background: var(--glass); backdrop-filter: blur(25px); 
            border-bottom: 1px solid var(--border); z-index: 1000; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: var(--shadow);
        }

        .logo { 
            display: flex; align-items: center; gap: 12px; font-size: 24px; 
            font-weight: 900; color: white; text-decoration: none;
        }
        .logo img { 
            width: 55px; height: 55px; border-radius: 50%; object-fit: cover; 
            box-shadow: 0 0 10px var(--primary); transition: 0.4s;
        }
        .logo:hover img { transform: scale(1.1) rotate(360deg); }

        .back-btn {
            padding: 12px 30px; background: var(--primary); color: white; 
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
            text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
            transition: 0.3s;
        }
        .back-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }

        .container { max-width: 1200px; margin: 100px auto 50px; padding: 20px; }

        .section-header {
            background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 12px; padding: 30px;
            margin-bottom: 30px; box-shadow: var(--shadow);
            display: flex; justify-content: space-between; align-items: center;
        }

        .section-info h1 { 
            font-size: 32px; color: var(--primary); margin-bottom: 10px;
        }

        .section-info p { 
            color: var(--text-secondary); font-size: 16px;
        }

        .user-badge {
            background: rgba(231, 76, 60, 0.1); border: 1px solid var(--primary);
            padding: 12px 20px; border-radius: 8px; color: white;
            display: flex; align-items: center; gap: 10px;
            font-weight: 600;
        }

        .user-badge i { color: var(--primary); }

        .post-form {
            background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 12px; 
            padding: 30px; margin-bottom: 30px; box-shadow: var(--shadow);
        }

        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; margin-bottom: 8px; color: var(--text-secondary); 
            font-weight: 600; font-size: 14px; text-transform: uppercase;
        }
        
        .form-input, .form-textarea {
            width: 100%; padding: 12px 15px; background: rgba(255,255,255,0.03);
            border: 1px solid var(--border); border-radius: 8px; color: white;
            font-family: inherit; transition: 0.3s; font-size: 14px;
        }

        .form-textarea { min-height: 140px; resize: vertical; }

        .form-input:focus, .form-textarea:focus {
            outline: none; border-color: var(--primary); 
            box-shadow: 0 0 15px rgba(231,76,60,0.3);
            background: rgba(231,76,60,0.05);
        }

        .form-buttons {
            display: flex; gap: 12px;
        }

        .submit-btn, .cancel-btn {
            padding: 12px 30px; border: none; border-radius: 8px; 
            font-weight: 700; cursor: pointer; transition: 0.3s;
            font-size: 14px;
        }

        .submit-btn {
            background: var(--primary); color: white;
        }

        .submit-btn:hover {
            background: var(--primary-dark); transform: translateY(-2px);
        }

        .cancel-btn {
            background: transparent; color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .cancel-btn:hover {
            background: rgba(255,255,255,0.05); color: white;
        }

        .posts-container {
            display: flex; flex-direction: column; gap: 20px;
        }

        .post {
            background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 12px; 
            padding: 25px; transition: all 0.3s; box-shadow: var(--shadow);
        }

        .post:hover { 
            border-color: var(--primary); 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(231,76,60,0.25);
        }

        .post-header { 
            display: flex; justify-content: space-between; align-items: flex-start; 
            margin-bottom: 15px; padding-bottom: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .post-author { 
            display: flex; align-items: center; gap: 12px;
        }

        .author-avatar {
            width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; color: white; font-size: 18px;
            box-shadow: 0 0 10px rgba(231,76,60,0.4);
        }

        .author-info h4 {
            font-size: 15px; color: white; margin-bottom: 4px;
        }

        .post-date { 
            font-size: 12px; color: rgba(255,255,255,0.5);
        }

        .post-title { 
            font-size: 22px; margin: 15px 0 10px; 
            color: white; font-weight: 700;
        }

        .post-content { 
            color: var(--text-secondary); line-height: 1.7; 
            font-size: 14px; margin: 15px 0;
        }

        .post-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 15px; padding-top: 15px; 
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 12px; color: rgba(255,255,255,0.5);
        }

        .empty-state { 
            text-align: center; padding: 100px 20px; 
            background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 12px;
            color: var(--text-secondary);
        }

        .empty-state i { 
            font-size: 80px; color: var(--primary); 
            opacity: 0.3; margin-bottom: 20px; display: block;
        }

        .empty-state p {
            font-size: 18px; font-weight: 500;
        }

        .loading { 
            text-align: center; padding: 80px 20px; 
            color: var(--text-secondary);
        }

        .loading i { 
            font-size: 60px; color: var(--primary); 
            animation: spin 2s linear infinite;
            display: block; margin-bottom: 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 30px; right: 30px; 
            background: var(--primary); color: white; 
            padding: 15px 30px; border-radius: 8px; z-index: 10000;
            opacity: 0; transform: translateY(20px); 
            transition: all 0.4s ease; box-shadow: var(--shadow);
        }

        .toast.show { opacity: 1; transform: translateY(0); }

        .toast.error { background: #c0392b; }
        .toast.success { background: #27ae60; }

        @media (max-width: 768px) {
            .section-header { 
                flex-direction: column; 
                text-align: center; 
                gap: 20px;
            }
            
            .section-info h1 { font-size: 24px; }
            
            .form-buttons { 
                flex-direction: column;
            }

            .post-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="glow-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div id="particles-js"></div>

    <header>
        <a href="index.html" class="logo">
            <img src="https://raw.githubusercontent.com/OGSunny/Testerweb/main/lv_0_20251120194047.jpg" alt="Zaratic RP">
            <span>Zaratic RP</span>
        </a>
        <a href="forum.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            უკან ფორუმში
        </a>
    </header>

    <div class="container">
        <div class="section-header">
            <div class="section-info">
                <h1 id="sectionTitle">სექციის სათაური</h1>
                <p id="sectionDesc">სექციის აღწერილობა</p>
            </div>
            <div class="user-badge">
                <i class="fas fa-user"></i>
                <span id="currentUserDisplay">სტუმარო</span>
            </div>
        </div>

        <div id="postFormContainer"></div>
        <div id="postsContainer"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
    <script>
        const KV_URL = "https://zaraticdb.jemalagegidze.workers.dev/kv";

        const forumData = {
            'rules': { title: 'სერვერის საერთო წესები', desc: 'სერვერის წესები და რეგულაციები', official: true },
            'news': { title: 'სერვერის სიახლეები', desc: 'უახლესი სიახლეები სერვერზე', official: true },
            'updates': { title: 'სერვერის განახლებები', desc: 'სერვერის განახლებები და ცვლილებები', official: true },
            'info': { title: 'საინფორმაციო განყოფილება', desc: 'ზოგადი ინფორმაცია', official: false },
            'suggestions': { title: 'შემოთავაზებები', desc: 'თქვენი შემოთავაზებები სერვერის გასაუმჯობესებლად', official: false },
            'events': { title: 'ღონისძიებები', desc: 'სერვერის ღონისძიებები და ტურნირები', official: false },
            'biographies': { title: 'RP ბიოგრაფიები', desc: 'მოთამაშეთა RP ბიოგრაფიები', official: false },
            'complaints-admin': { title: 'საჩივრები ადმინზე', desc: 'საჩივრები ადმინისტრაციის წევრებზე', official: false },
            'complaints-player': { title: 'საჩივრები მოთამაშეზე', desc: 'საჩივრები სხვა მოთამაშეებზე', official: false },
            'appeals': { title: 'სასჯელის გასაჩივრება', desc: 'სასჯელის შემცირება/შეწყალება', official: false },
            'vacancies-leaders': { title: 'ვაკანსია ლიდერებზე', desc: 'ლიდერის პოზიციები', official: false },
            'vacancies-admin': { title: 'ვაკანსია ადმინზე', desc: 'ადმინისტრაციაში ვაკანსიები', official: false },
            'vacancies-partner': { title: 'პარტნიორობა', desc: 'პარტნიორობის შეთავაზებები', official: false },
            'donation-help': { title: 'დახმარება დონაციაზე', desc: 'დონაციასთან დაკავშირებით', official: false },
            'tech-help': { title: 'ტექნიკური დახმარება', desc: 'ტექნიკური პრობლემები', official: false }
        };

        const adminUsers = ['Zviadi Gegidze', 'Nika Georgadze'];
        let currentUser = localStorage.getItem('forum_username') || 'სტუმარო';
        let currentSection = new URLSearchParams(location.search).get('id') || 'rules';
        let isLoading = false;

        document.getElementById('currentUserDisplay').textContent = currentUser;

        // Initialize particles
        particlesJS('particles-js', {
            particles: {
                number: { value: 0 },
                opacity: { value: 0 },
                size: { value: 0 }
            },
            retina_detect: true
        });

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `toast show ${type}`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        async function loadPosts() {
            if (isLoading) return;
            isLoading = true;

            const info = forumData[currentSection] || { title: currentSection, desc: '', official: false };
            
            document.getElementById('sectionTitle').textContent = info.title;
            document.getElementById('sectionDesc').textContent = info.desc;

            const canPost = currentUser !== 'სტუმარო' && (!info.official || adminUsers.includes(currentUser));

            // Render form only once
            if (!document.getElementById('postFormContainer').innerHTML) {
                if (canPost) {
                    document.getElementById('postFormContainer').innerHTML = `
                        <div class="post-form">
                            <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 18px;">
                                <i class="fas fa-plus" style="margin-right: 8px;"></i> ახალი პოსტი
                            </h3>
                            <form id="postForm">
                                <div class="form-group">
                                    <label><i class="fas fa-heading" style="margin-right: 8px;"></i>სათაური</label>
                                    <input type="text" id="postTitle" class="form-input" required placeholder="მიუთითეთ თემის სათაური">
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-pen" style="margin-right: 8px;"></i>შინაარსი</label>
                                    <textarea id="postContent" class="form-textarea" required placeholder="დაწერეთ თქვენი პოსტი..."></textarea>
                                </div>
                                <div class="form-buttons">
                                    <button type="submit" class="submit-btn">
                                        <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>გამოქვეყნება
                                    </button>
                                    <button type="reset" class="cancel-btn">
                                        <i class="fas fa-times" style="margin-right: 8px;"></i>გაწმენა
                                    </button>
                                </div>
                            </form>
                        </div>`;
                    
                    document.getElementById('postForm').addEventListener('submit', sendPost);
                }
            }

            try {
                const res = await fetch(`${KV_URL}?section=${currentSection}`, { cache: "no-store" });
                const posts = res.ok ? await res.json() : [];

                let html = '';

                if (posts.length === 0) {
                    html = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>ჯერ არ არის შექმნილი პოსტები ამ განყოფილებაში</p>
                            <p style="font-size: 13px; margin-top: 10px; color: rgba(255,255,255,0.4);">
                                პირველი იყავი, რომელიც დაწერე პოსტი!
                            </p>
                        </div>`;
                } else {
                    html = `<div class="posts-container">`;
                    posts.forEach((p, idx) => {
                        const date = new Date(p.timestamp).toLocaleString('ka-GE');
                        const letter = p.author.charAt(0).toUpperCase();
                        html += `
                            <div class="post">
                                <div class="post-header">
                                    <div class="post-author">
                                        <div class="author-avatar">${letter}</div>
                                        <div class="author-info">
                                            <h4>${escapeHtml(p.author)}</h4>
                                            <div class="post-date">${date}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="post-title">${escapeHtml(p.title)}</div>
                                <div class="post-content">${escapeHtml(p.content).replace(/\n/g, '<br>')}</div>
                                <div class="post-footer">
                                    <span>#${idx + 1}</span>
                                </div>
                            </div>`;
                    });
                    html += `</div>`;
                }

                document.getElementById('postsContainer').innerHTML = html;

            } catch (err) {
                document.getElementById('postsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>შეცდომა სერვერთან კავშირში</p>
                        <p style="font-size: 13px; margin-top: 10px; color: rgba(255,255,255,0.4);">
                            ${err.message}
                        </p>
                    </div>`;
            }

            isLoading = false;
        }

        async function sendPost(e) {
            e.preventDefault();
            
            if (currentUser === 'სტუმარო') {
                showToast('გთხოვთ შეხვიდეთ სისტემაში', 'error');
                return;
            }

            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            
            if (!title || !content) {
                showToast('გთხოვთ, შეავსოთ ყველა ველი', 'error');
                return;
            }

            const post = { author: currentUser, title, content, timestamp: Date.now() };

            try {
                const res = await fetch(KV_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ section: currentSection, post })
                });

                if (res.ok) {
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postContent').value = '';
                    showToast('პოსტი წარმატებით გამოქვეყნდა!', 'success');
                    setTimeout(loadPosts, 500);
                } else {
                    showToast('დაჭეა პოსტის გამოქვეყნება', 'error');
                }
            } catch (err) {
                showToast('შეცდომა: ' + err.message, 'error');
            }
        }

        // Initial load
        loadPosts();
        
        // Refresh posts every 5 seconds
        setInterval(loadPosts, 5000);
    </script>
</body>
</html>
