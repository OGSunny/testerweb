<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>სექცია • Zaratic RP</title>
  <link rel="icon" href="https://raw.githubusercontent.com/OGSunny/Testerweb/main/lv_0_20251120194047.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root { --red:#e74c3c; --dark:#0f0f0f; --glass:rgba(20,20,30,0.9); --border:rgba(231,76,60,0.3); }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Noto Sans Georgian',sans-serif; background:#000; color:#eee; font-size:14px; }
    header { position:fixed; top:0; width:100%; padding:12px 20px; background:var(--glass); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); z-index:1000; display:flex; justify-content:space-between; align-items:center; }
    .logo img { width:36px; height:36px; border-radius:50%; }
    .back { color:white; text-decoration:none; font-size:14px; }
    .container { max-width:1100px; margin:70px auto 20px; padding:0 15px; display:grid; grid-template-columns:240px 1fr; gap:20px; }
    .sidebar { background:var(--glass); border:1px solid var(--border); border-radius:8px; padding:16px; position:sticky; top:70px; height:fit-content; }
    .sidebar a { display:block; padding:8px 0; color:#ccc; text-decoration:none; font-size:13px; }
    .sidebar a.active, .sidebar a:hover { color:var(--red); }
    .main { background:var(--glass); border:1px solid var(--border); border-radius:8px; padding:18px; }
    h1 { font-size:18px; color:var(--red); margin-bottom:12px; }
    #postForm { margin-bottom:20px; display:none; }
    #postForm.show { display:block; }
    input, textarea { width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:6px; padding:10px; color:white; margin:8px 0; font-family:inherit; font-size:13px; }
    textarea { min-height:90px; resize:vertical; }
    .btns { display:flex; gap:8px; }
    button { padding:8px 14px; background:var(--red); color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; }
    button.secondary { background:transparent; border:1px solid var(--red); }
    .post { background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:8px; padding:14px; margin-bottom:12px; }
    .post-header { display:flex; align-items:center; gap:10px; margin-bottom:8px; font-size:13px; }
    .avatar { width:32px; height:32px; background:var(--red); border-radius:50%; display:grid; place-items:center; font-weight:bold; font-size:12px; }
    .author { font-weight:600; }
    .time { margin-left:auto; color:#999; }
    .title { font-size:16px; color:var(--red); margin-bottom:6px; }
    .content { white-space:pre-wrap; color:#ddd; }
    .actions { margin-top:10px; opacity:0; transition:0.2s; }
    .post:hover .actions { opacity:1; }
    .actions button { background:none; color:#999; font-size:16px; padding:0 6px; cursor:pointer; }
    .actions button:hover { color:var(--red); }
    @media (max-width:800px) { .container { grid-template-columns:1fr; } .sidebar { position:static; } }
  </style>
</head>
<body>
  <header>
    <a href="forum.html" class="logo">
      <img src="https://raw.githubusercontent.com/OGSunny/Testerweb/main/lv_0_20251120194047.jpg" alt="Zaratic RP">
      Zaratic RP
    </a>
    <a href="forum.html" class="back"><i class="fas fa-arrow-left"></i> უკან</a>
  </header>

  <div class="container">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main">
      <h1 id="sectionTitle"></h1>

      <form id="postForm">
        <input type="text" id="title" placeholder="სათაური" required>
        <textarea id="content" placeholder="ტექსტი..." required></textarea>
        <div class="btns">
          <button type="submit">გამოქვეყნება</button>
          <button type="button" class="secondary" onclick="cancelEdit()">გაუქმება</button>
        </div>
      </form>

      <div id="posts"></div>
    </main>
  </div>

  <script>
    const worker = 'https://data.jemalagegidze.workers.dev';
    const user = localStorage.getItem('username');
    if (!user) location.href = 'login.html';

    const params = new URLSearchParams(location.search);
    const section = params.get('id');
    const locked = ['rules','news','updates'];
    const isLocked = locked.includes(section);
    const admins = ['Zviadi Gegidze', 'Nika Georgadze'];
    const isAdmin = admins.includes(user);

    const titles = {rules:'წესები',news:'სიახლეები',updates:'განახლებები',info:'ინფორმაცია',suggestions:'წინადადებები',events:'ივენთები',biographies:'ბიოგრაფიები','complaints-admin':'საჩივარი ადმინზე','complaints-player':'საჩივარი მოთამაშეზე',appeals:'აპელაციები','vacancies-leaders':'ლიდერები','vacancies-admin':'ადმინის ვაკანსიები','vacancies-partner':'პარტნიორები','donation-help':'დონატი','tech-help':'ტექ. დახმარება'};
    document.getElementById('sectionTitle').textContent = titles[section] || section;

    if (!isLocked || isAdmin) document.getElementById('postForm').classList.add('show');

    const sidebar = document.getElementById('sidebar');
    const cats = ['rules','news','updates','info','suggestions','events','biographies','complaints-admin','complaints-player','appeals','vacancies-leaders','vacancies-admin','vacancies-partner','donation-help','tech-help'];
    cats.forEach(c => {
      const a = document.createElement('a');
      a.href = `section.html?id=${c}`;
      a.textContent = titles[c] || c;
      if (c===section) a.classList.add('active');
      sidebar.appendChild(a);
    });

    async function loadPosts() {
      const res = await fetch(`${worker}/?section=${section}`);
      const posts = await res.json();
      posts.sort((a,b)=>b.timestamp - a.timestamp);
      const div = document.getElementById('posts');
      div.innerHTML = posts.length ? posts.map(p => `
        <div class="post">
          <div class="post-header">
            <div class="avatar">${p.author[0].toUpperCase()}</div>
            <div class="author">${p.author}</div>
            <div class="time">${new Date(p.timestamp).toLocaleString('ka-GE')}</div>
          </div>
          <div class="title">${p.title}</div>
          <div class="content">${p.content.replace(/\n/g,'<br>')}</div>
          ${(p.author===user || isAdmin) ? `
          <div class="actions">
            ${p.author===user || isAdmin ? `<button onclick="edit(${p.timestamp},'${p.title.replace(/'/g,"\\'")}','${p.content.replace(/'/g,"\\'")}')"><i class="fas fa-edit"></i></button>` : ''}
            ${isAdmin ? `<button onclick="del(${p.timestamp})"><i class="fas fa-trash"></i></button>` : ''}
          </div>` : ''}
        </div>
      `).join('') : '<p style="text-align:center;color:#999 Philippines">პოსტები არ არის</p>';
    }

    document.getElementById('postForm').onsubmit = async e => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      if (!title || !content) return;

      const post = {author:user, title, content, timestamp:Date.now()};
      await fetch(worker, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'create',section,post})});
      document.getElementById('postForm').reset();
      loadPosts();
    };

    window.edit = (ts, t, c) => {
      document.getElementById('title').value = t;
      document.getElementById('content').value = c;
      document.getElementById('postForm').onsubmit = async e => {
        e.preventDefault();
        const newTitle = document.getElementById('title').value.trim();
        const newContent = document.getElementById('content').value.trim();
        await fetch(worker, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'edit',section,timestamp:ts,title:newTitle,content:newContent,post:{author:user}})});
        document.getElementById('postForm').reset();
        document.getElementById('postForm').onsubmit = document.getElementById('postForm').onsubmit;
        loadPosts();
      };
    };

    window.del = async ts => {
      if (!confirm('წაშლა?')) return;
      await fetch(worker, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'delete',section,timestamp:ts,post:{author:user}})});
      loadPosts();
    };

    function cancelEdit() {
      document.getElementById('postForm').reset();
      document.getElementById('postForm').onsubmit = document.getElementById('postForm').onsubmit;
    }

    loadPosts();
    setInterval(loadPosts, 15000);
  </script>
</body>
</html>
